FROM ubuntu:24.04

# 查看代理
# systemctl show --property=Environment docker

# docker build \
#   --build-arg http_proxy=http://127.0.0.1:7890 \
#   --build-arg https_proxy=http://127.0.0.1:7890 \
# docker build --build-arg http_proxy=http://192.168.51.198:7890 --build-arg https_proxy=http://192.168.51.198:7890 -t typemoonl/rei:latest .
# docker build --progress=plain -t typemoonl/rei:latest .
# CGO_ENABLED=0 GOARCH=amd64 go build -o ./rei -a -ldflags '-extldflags "-static"' main.go

RUN apt-get update && apt-get install -y \
    bash \
    procps \
    grep \
    vim \
    curl \
    iputils-ping \
    net-tools sqlite3 libsqlite3-dev systemd sudo openssh-server unzip bc rsync

COPY ./docker/etc_conf/sshd_config /etc/ssh/sshd_config
RUN mkdir /run/sshd
RUN mkdir -p /home/rei

WORKDIR /home/kotori
RUN useradd -s /bin/bash -d /home/kotori kotori
RUN echo "kotori:ichinoserei" | chpasswd
RUN mkdir /home/kotori/mysql
COPY ./docker/etc_conf/sudoers /etc/sudoers
RUN chmod u=r,g=r,o= /etc/sudoers

WORKDIR /home/kotori/mysql
COPY ./mysql.tar ./mysql.tar

RUN tar -xf mysql.tar
RUN rm mysql.tar
RUN apt-get install -y ./mysql-*.deb
RUN echo $(pwd)
RUN echo $(ls -lh)
RUN rm ./*.deb -f

WORKDIR /home/rei
RUN mkdir /home/rei/proc_logs

RUN echo $(pwd)
RUN mkdir -p /home/rei/sunny_peace_rei/supervisor

RUN echo $(pwd)

COPY ./conf ./sunny_peace_rei/conf
COPY ./logs ./sunny_peace_rei/logs
COPY ./resources ./sunny_peace_rei/resources
COPY ./rei ./sunny_peace_rei/rei
COPY ./systemd ./sunny_peace_rei/systemd
COPY ./upload ./sunny_peace_rei/upload


# 设置执行权限（通常不需要，但保险起见）
RUN chmod +x /home/rei/sunny_peace_rei/rei
RUN chown -R kotori:kotori /home/rei /home/kotori

# 设置启动命令
CMD ["./rei", "-config", "conf/config.yaml"]

